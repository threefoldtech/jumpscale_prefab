
from Jumpscale import j

base = j.tools.prefab._getBaseClass()

ZEROTIERKEY = '''\
-----BEGIN PGP PUBLIC KEY BLOCK-----
Comment: GPGTools - https://gpgtools.org

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
=JgAv
-----END PGP PUBLIC KEY BLOCK-----
'''


class PrefabChroot(base):

    def __init__(self, prefab):
        self.prefab = prefab
        self.path = '/tmp/{}'.format(j.data.idgenerator.generateGUID())

    def __enter__(self):
        self.prefab.core.dir_ensure(self.path + '/proc')
        self.prefab.core.dir_ensure(self.path + '/dev')
        self.prefab.core.dir_ensure(self.path + '/sys')
        self.prefab.core.run('mount -o bind /proc {}/proc'.format(self.path))
        self.prefab.core.run('mount -o bind /dev {}/dev'.format(self.path))
        self.prefab.core.run('mount -o bind /sys {}/sys'.format(self.path))
        return self

    def __exit__(self, *args):
        self.prefab.core.run('umount {}/proc'.format(self.path))
        self.prefab.core.run('umount {}/dev'.format(self.path))
        self.prefab.core.run('umount {}/sys'.format(self.path))

    def install_ubuntu(self, distro='xenial'):
        self.prefab.core.dir_ensure(self.path)
        self.prefab.core.command_ensure('debootstrap')
        self.prefab.core.run('debootstrap {} {} http://ftp.belnet.be/ubuntu.com/ubuntu'.format(distro, self.path))
        sources = '''\
deb http://archive.ubuntu.com/ubuntu/ {0} main universe multiverse restricted
deb http://download.zerotier.com/debian/{0} {0} main
'''.format(distro)
        self.write_file('/etc/apt/sources.list', sources)
        locales = '''\
en_US.UTF-8 UTF-8
en_GB.UTF-8 UTF-8
'''
        self.write_file('/etc/locale.gen', locales)

    def execute(self, cmd):
        cmd = "chroot {} bash -c '{}'".format(self.path, cmd)
        self.prefab.core.run(cmd)

    def write_file(self, path, content):
        path = self.path + path
        self.prefab.core.file_write(path, content)


class PrefabUbuntu(base):

    def _init(self):
        pass

    def build_flist(self, dist, passwd, jwt):
        chroot = PrefabChroot(self.prefab)
        chroot.install_ubuntu(dist)
        with chroot:
            chroot.execute('locale-gen')
            modules = '''\
9p
9pnet
9pnet_virtio
9pnet_rdma
'''
            chroot.write_file('/etc/initramfs-tools/modules', modules)
            chroot.write_file('/etc/fstab', 'root	/	9p	rw,cache=loose,trans=virtio	0 0')
            netconfig = '''\
auto ens4
iface ens4 inet dhcp
'''
            chroot.write_file('/etc/network/interfaces.d/ens4', netconfig)
            chroot.write_file('/etc/hostname', 'ubuntu')
            chroot.write_file('/etc/resolv.conf', 'nameserver 8.8.8.8')
            chroot.write_file('/tmp/ztkey', ZEROTIERKEY)
            chroot.execute('apt-key add /tmp/ztkey')
            chroot.execute('apt-get update')
            chroot.execute('apt-get install -y --allow-unauthenticated --no-install-recommends mc openssh-server linux-generic wget zerotier-one ca-certificates curl acpid')
            chroot.execute('update-initramfs -u')
            kernel = j.sal.fs.getBaseName(self.prefab.core.find('{}/boot'.format(chroot.path), False, './vmlinuz-*')[0])
            initrd = j.sal.fs.getBaseName(self.prefab.core.find('{}/boot'.format(chroot.path), False, './initrd.img-*')[0])
            bootyaml = '''\
kernel: /boot/{}
initrd: /boot/{}
'''.format(kernel, initrd)
            chroot.write_file('/boot/boot.yaml', bootyaml)
            chroot.execute('echo "root:{}" | chpasswd'.format(passwd))
        tarfile = '/tmp/ubuntu-{}.tar.gz'.format(dist)
        self.prefab.core.dir_remove('{}/var/apt/cache/archives'.format(chroot.path))
        self.prefab.core.run('tar czpf {} -C {} .'.format(tarfile, chroot.path))
        if jwt:
            self.prefab.core.run('curl -b "caddyoauth={}" -F file=@{} https://hub.gig.tech/api/flist/me/upload'.format(jwt, tarfile))
        self.prefab.core.dir_remove(chroot.path)
        return tarfile
